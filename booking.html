<!doctype html>
<html>
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Booking — JHOM</title>
  <link rel="stylesheet" href="index.css">
  <script src="app-config.js"></script>
</head>
<body>
  <header class="header"><div class="brand"><img src="logo.jpg"> Reservation</div><nav><a class="btn btn-outline" href="room.html">Back</a></nav></header>
  <main class="container"><section class="card"><h2>Reservation Form</h2><div id="roomDetails" style="display:flex;gap:12px;align-items:center"></div>
      <form id="bookingForm">
        <input class="input" name="fullName" placeholder="Full name" required style="margin:8px 0">
        <input class="input" name="checkIn" type="date" required style="margin:8px 0">
        <select class="input" name="paymentMethod" required style="margin:8px 0"><option value="">--Select--</option><option value="cash">Cash</option><option value="online">Online</option></select>
        <label class="kv">Ticket Reference</label>
        <input class="input" id="ticketRef" name="ticketRef" readonly style="margin:8px 0">
        <div style="display:flex;gap:8px"><button type="submit" class="btn btn-primary">Confirm Booking</button><button type="button" class="btn btn-outline" id="genRef">Regenerate Ref</button></div>
      </form></section>
  </main>
  <footer class="footer">© 2025 JHOM</footer>

  <script>
    function lsget(k){return JSON.parse(localStorage.getItem(k)||'null')}
    const selId = localStorage.getItem('selectedRoomId');
    if(!selId){ alert('No room selected'); location.href='room.html'; }
    async function loadRoom(){
      try {
        const res = await fetch(BACKEND_URL + '/rooms');
        const rooms = await res.json();
        const r = rooms.find(x => String(x.id) === String(selId));
        if(!r){ alert('Room not found'); location.href='room.html'; return; }
        document.getElementById('roomDetails').innerHTML = `<img src="${r.image||'placeholder1.jpg'}" style="width:140px;height:90px;object-fit:cover;border-radius:8px;margin-right:12px"><div><strong>${r.name||'Room '+r.roomNumber}</strong><div class="kv">Room #: ${r.roomNumber||r.id}</div><div class="kv">₱ ${Number(r.price||0).toLocaleString()}</div></div>`;
        document.getElementById('ticketRef').value = createRef();
        document.getElementById('genRef').onclick = () => document.getElementById('ticketRef').value = createRef();
        document.getElementById('bookingForm').onsubmit = e => submit(e, r);
      } catch {
        alert('Error loading room');
      }
    }
    function createRef(){
      const d=new Date();
      return `REF-${d.getFullYear()}${('0'+(d.getMonth()+1)).slice(-2)}${('0'+d.getDate()).slice(-2)}-${Math.floor(100000 + Math.random()*900000)}`;
    }
    async function submit(e, room){
      e.preventDefault();
      const f = new FormData(e.target);
      const fullName = (f.get('fullName')||'').trim();
      const checkIn = f.get('checkIn');
      const paymentMethod = f.get('paymentMethod');
      const ticketRef = document.getElementById('ticketRef').value;
      if(!fullName || !checkIn || !paymentMethod){ alert('Please fill required'); return; }
      const payload = { fullName, checkIn, paymentMethod, ticketRef, room: { id: room.id, roomNumber: room.roomNumber, name: room.name, price: room.price } };
      try {
        const res = await fetch(BACKEND_URL + '/bookings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if(data.success){
          let cart = lsget('cart')||[]; cart = cart.filter(x=>String(x)!==String(room.id)); localStorage.setItem('cart', JSON.stringify(cart));
          alert('Booking created');
          location.href = 'notification.html';
        } else alert('Error: ' + JSON.stringify(data));
      } catch {
        alert('Network error');
      }
    }
    loadRoom();
  </script>
</body>
</html>
